<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Usuarios</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Asegúrate de que la ruta al CSS sea correcta -->
  <link rel="stylesheet" href="../style/style_user.css"> 
</head>
<body>
  <div class="page-wrapper">
    
    <div class="sidebar-overlay"></div>

    <aside class="sidebar">
        <!-- El sidebar no cambia -->
        <div class="sidebar-header text-center">
            <div class="user-avatar mx-auto mb-2">
                <img src="../img/logo_sintergia.png" width="80px" alt="Logo Sintergia"> 
            </div>
            <h5 class="user-name">Nombre de Usuario</h5>
            <p class="user-role text-white-50">Administrador</p>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-house-door-fill"></i> Home</a></li>
            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-heart-fill"></i> Pacientes</a></li>
            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-bar-chart-fill"></i> Auditoría</a></li>
        </ul>
        <a href="#" class="btn btn-logout mt-auto"><i class="bi bi-box-arrow-left"></i> Cerrar sesión</a>
    </aside>

    <main class="main-content">
      <button class="btn d-lg-none mb-3" id="sidebar-toggle"><i class="bi bi-list"></i></button>
      <header class="content-header">Gestión de Usuarios</header>
      
      <!-- La sección de búsqueda y creación no cambia en su estructura HTML -->
      <div class="top-controls-wrapper">
        <form class="search-form">
          <!-- ... Contenido del formulario de búsqueda ... -->
        </form>
        <div class="create-user-button-container">
            <button class="btn btn-create-user" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="bi bi-plus"></i> Crear Usuario
            </button>
        </div>
      </div>
      
      <div class="user-list-container">
          <div class="user-list-header">
              <span>Usuario</span>
              <span>Rol</span>
              <span>Estado</span>
              <span>Acciones</span>
          </div>
          <!-- IMPORTANTE: El contenido de la lista ahora está vacío. Se llenará con JavaScript. -->
          <div class="user-list" id="user-list">
              <!-- Los usuarios se cargarán aquí dinámicamente -->
          </div>
      </div>
    </main>
  </div>

  <!-- El Modal para crear usuario no cambia en su estructura HTML -->
  <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="createUserModalLabel">Crear Nuevo Usuario</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-user-form">
            <div class="mb-3">
                <label for="new-rut" class="form-label">RUT</label>
                <input type="text" class="form-control" id="new-rut" required>
            </div>
            <div class="mb-3">
                <label for="new-name" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="new-name" required>
            </div>
            <div class="mb-3">
                <label for="new-lastname" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="new-lastname" required>
            </div>
            <div class="mb-3">
                <label for="new-role" class="form-label">Rol</label>
                <select class="form-select" id="new-role" required>
                    <option value="Administrador">Administrador</option>
                    <option value="Usuario" selected>Usuario</option>
                    <option value="Auditor">Auditor</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="new-password" class="form-label">Contraseña Temporal</label>
                <input type="password" class="form-control" id="new-password" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="create-user-form" class="btn btn-primary">Guardar Usuario</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

 
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- LÓGICA DEL SIDEBAR (sin cambios) ---
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const pageWrapper = document.querySelector('.page-wrapper');
      const sidebarOverlay = document.querySelector('.sidebar-overlay');
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => pageWrapper.classList.toggle('sidebar-visible'));
        sidebarOverlay.addEventListener('click', () => pageWrapper.classList.remove('sidebar-visible'));
      }

      // --- LÓGICA PARA CONECTAR CON EL BACKEND ---
      
      const API_URL = 'http://localhost:3001/api/usuarios'; // URL de tu backend
      const userList = document.getElementById('user-list');
      const createUserForm = document.getElementById('create-user-form');
      const createUserModal = new bootstrap.Modal(document.getElementById('createUserModal'));

      // --- FUNCIONES DE AYUDA PARA EL RUT ---
      
      /**
       * Limpia un RUT quitando puntos y guion.
       * @param {string} rut - El RUT con formato.
       * @returns {string} El RUT limpio (ej: "123456789").
       */
      const limpiarRut = (rut) => {
        return rut.replace(/[\.\-]/g, '');
      };

      /**
       * Formatea un RUT limpio a un formato legible (xx.xxx.xxx-x).
       * @param {string} rut - El RUT limpio.
       * @returns {string} El RUT con formato.
       */
      const formatearRut = (rut) => {
        let actual = limpiarRut(rut).toUpperCase();
        let sinDv = actual.slice(0, -1);
        let dv = actual.slice(-1);
        let rutFormateado = '';
        while (sinDv.length > 3) {
            rutFormateado = '.' + sinDv.slice(-3) + rutFormateado;
            sinDv = sinDv.slice(0, -3);
        }
        return sinDv + rutFormateado + '-' + dv;
      };


      // Función para renderizar los usuarios en la tabla
      const renderizarUsuarios = (usuarios) => {
        userList.innerHTML = ''; // Limpiamos la lista antes de renderizar
        // Ajustamos las columnas de la grilla para el nuevo campo RUT
        userList.style.gridTemplateColumns = '1.5fr 2fr 1fr 1fr 1fr';

        usuarios.forEach(user => {
          const userItem = document.createElement('div');
          userItem.className = 'user-list-item';
          // También ajustamos aquí para que coincida
          userItem.style.gridTemplateColumns = '1.5fr 2fr 1fr 1fr 1fr';
          
          const estadoClass = user.estado === 'Activo' ? 'status-active' : 'status-inactive';

          userItem.innerHTML = `
            <span>${formatearRut(user.rut)}</span>
            <span>${user.nombre} ${user.apellido}</span>
            <span>${user.rol}</span>
            <span><span class="status-badge ${estadoClass}">${user.estado}</span></span>
            <div>
                <button class="btn btn-sm btn-outline-primary" title="Editar"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${user._id}" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
            </div>
          `;
          userList.appendChild(userItem);
        });
      };

      // Función para obtener y mostrar los usuarios
      const cargarUsuarios = async () => {
        try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error('Error al cargar los usuarios');
          const usuarios = await response.json();
          renderizarUsuarios(usuarios);
        } catch (error) {
          console.error(error);
          userList.innerHTML = '<p class="text-center text-danger">No se pudieron cargar los usuarios.</p>';
        }
      };

      // Función para crear un nuevo usuario
      createUserForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Obtenemos el RUT del formulario
        const rutInput = document.getElementById('new-rut').value;
        
        // ¡CAMBIO CLAVE! Limpiamos el RUT antes de enviarlo.
        const rutLimpio = limpiarRut(rutInput);

        const nuevoUsuario = {
          rut: rutLimpio, // Enviamos el RUT ya normalizado
          nombre: document.getElementById('new-name').value,
          apellido: document.getElementById('new-lastname').value,
          rol: document.getElementById('new-role').value,
          password: document.getElementById('new-password').value,
        };

        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(nuevoUsuario)
          });

          // Mejor manejo de errores desde el backend
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al crear el usuario');
          }
          
          createUserForm.reset(); // Limpia el formulario
          createUserModal.hide(); // Cierra el modal
          cargarUsuarios(); // Recarga la lista de usuarios
        } catch (error) {
          console.error(error);
          alert(`Error: ${error.message}`);
        }
      });
      
      // Función para eliminar un usuario (sin cambios)
      userList.addEventListener('click', async (event) => {
        const deleteButton = event.target.closest('.btn-delete');
        if (deleteButton) {
          const userId = deleteButton.dataset.id;
          const confirmar = confirm('¿Estás seguro de que quieres eliminar este usuario?');
          if (confirmar) {
            try {
              const response = await fetch(`${API_URL}/${userId}`, { method: 'DELETE' });
              if (!response.ok) throw new Error('Error al eliminar el usuario');
              cargarUsuarios();
            } catch (error) {
              console.error(error);
              alert('Error al eliminar el usuario.');
            }
          }
        }
      });

      // Carga inicial de usuarios
      cargarUsuarios();
    });
  </script>
</body>
</html>