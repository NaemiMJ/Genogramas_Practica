<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Genograma</title>
  <link rel="stylesheet" href="../style/style_geno.css">
  <!-- Konva para dibujar las conexiones -->
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    /* Reglas m칤nimas inline para que la estructura funcione.
       Si tu CSS ya define .middle-row, .hermanos, etc., puedes quitar estas. */
    .middle-row { display: flex; align-items: center; justify-content: center; position: relative; }
    .pareja-slot { width: 140px; display:flex; justify-content:center; }
    .center-block { display:flex; align-items:center; justify-content:center; gap:12px; }
    .hermanos { display:flex; gap:12px; align-items:center; }
    .paciente-slot { min-width:120px; display:flex; justify-content:center; }
    /* contenedor de Konva ocupa todo el 치rea para poder superponer las l칤neas */
    #conexiones { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
    .genograma-container { position:relative; }
  </style>
</head>
<body>
  <h1>Genograma</h1>
  <button id="btnGuardarDB" class="btn-save">游 Guardar Cambios</button

  <!-- Formulario inicial: solo paciente -->
  <div class="form-wrapper" id="formPaciente">
    <h3>Agregar paciente</h3>
    <label>Nombre: <input type="text" id="nombre" /></label>
    <label>Apellido: <input type="text" id="apellido" /></label>
    <label>Edad: <input type="number" id="edad" min="0" /></label>
    <label>Sexo:
      <select id="sexo">
        <option value="M">Masculino</option>
        <option value="F">Femenino</option>
      </select>
    </label>
    <div style="margin-top:8px">
      <button id="agregarPaciente">Agregar paciente</button>
    </div>
  </div>

  <!-- Contenedor genograma -->
  <div class="genograma-container">
    <!-- Konva dibuja sobre este div -->
    <div id="conexiones"></div>

    <div class="genograma">
      <!-- Padres -->
      <div class="fila padres" id="padres">
        <div class="parent-slot" id="padre-slot"></div>
        <div class="parent-slot" id="madre-slot"></div>
      </div>

      <!-- Fila central: pareja-izq | (hermanos-izq | paciente | hermanos-der) | pareja-der -->
      <div class="fila middle-row" id="middle">
        <div class="pareja-slot" id="partner-left-slot"></div>

        <div class="center-block" id="center-block">
          <div class="hermanos left" id="hermanos-left"></div>
          <div class="paciente-slot" id="paciente-slot"></div>
          <div class="hermanos right" id="hermanos-right"></div>
        </div>

        <div class="pareja-slot" id="partner-right-slot"></div>
      </div>

      <!-- Hijos -->
      <div class="fila hijos" id="hijos"></div>
    </div>
  </div>

  <!-- Modal para agregar familiares -->
  <div id="formFamiliar" class="modal oculto" role="dialog" aria-hidden="true">
    <div class="modal-inner">
      <h4>Agregar familiar</h4>
      <label>Nombre: <input type="text" id="famNombre" /></label>
      <label>Apellido: <input type="text" id="famApellido" /></label>
      <label>Edad: <input type="number" id="famEdad" min="0" /></label>
      <label>Sexo:
        <select id="famSexo">
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </label>
      <label>Rol:
        <select id="famRol">
          <option value="padre">Padre/Madre</option>
          <option value="pareja">Pareja</option>
          <option value="hermano">Hermano/a</option>
          <option value="hijo">Hijo/a</option>
        </select>
      </label>

      <div class="modal-actions" style="margin-top:8px;">
        <button id="guardarFamiliarBtn">Agregar</button>
        <button type="button" onclick="cerrarFormFamiliar()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Men칰 contextual -->
  <div id="menuAcciones" class="menu-acciones oculto">
    <button id="menuAgregar">Agregar familiar</button>
    <button id="menuEliminar">Eliminar</button>
    <button onclick="cerrarMenu()">Cerrar</button>
  </div>

<script>
/* ========== Modelo de datos ========== */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

let patient = null;
let parents = { father: null, mother: null };
let partner = null;
let siblings = [];
let children = [];
let seleccionado = null;

/* ========== Selectores DOM ========== */
const padreSlot = document.getElementById('padre-slot');
const madreSlot = document.getElementById('madre-slot');
const partnerLeftSlot = document.getElementById('partner-left-slot');
const partnerRightSlot = document.getElementById('partner-right-slot');
const hermanosLeft = document.getElementById('hermanos-left');
const hermanosRight = document.getElementById('hermanos-right');
const pacienteSlot = document.getElementById('paciente-slot');
const hijosSlot = document.getElementById('hijos');
const genogramaContainer = document.querySelector('.genograma-container');
const middleRow = document.getElementById('middle'); 
const hijosRow = document.getElementById('hijos'); 

// UI
const formPaciente = document.getElementById('formPaciente');
const agregarPacienteBtn = document.getElementById('agregarPaciente');
const menu = document.getElementById('menuAcciones');
const menuAgregarBtn = document.getElementById('menuAgregar');
const menuEliminarBtn = document.getElementById('menuEliminar');
const formFamiliar = document.getElementById('formFamiliar');
const guardarFamiliarBtn = document.getElementById('guardarFamiliarBtn');

/* ========== Utilidades ========== */
const getNum = v => { const n = parseInt(v); return Number.isFinite(n) ? n : null; };

function getCenterX(el) {
  const r = el.getBoundingClientRect();
  return r.left + r.width / 2;
}

/* ========== Crear nodo persona ========== */
function crearNodo(persona) {
  const div = document.createElement('div');
  div.className = 'persona ' + (persona.sexo === 'M' ? 'hombre' : 'mujer') + (persona.esPaciente ? ' paciente' : '');
  div.dataset.id = persona.id;

  const nombre = document.createElement('div');
  nombre.className = 'nombre';
  nombre.textContent = persona.nombre + (persona.apellido ? (' ' + persona.apellido) : '');

  const edad = document.createElement('div');
  edad.className = 'edad';
  edad.textContent = persona.edad ? (persona.edad + ' a침os') : '';

  div.appendChild(nombre);
  div.appendChild(edad);

  div.addEventListener('click', (e) => {
    e.stopPropagation();
    seleccionado = persona;
    abrirMenu(e.pageX, e.pageY);
  });
  return div;
}

/* ========== Konva Config ========== */
let stage = null;
let layer = null;

/* ========== L칩gica de Alineaci칩n ========== */
function alinearGenograma() {
  middleRow.style.transform = '';
  hijosRow.style.transform = '';

  const fatherDom = padreSlot.querySelector('.persona');
  const motherDom = madreSlot.querySelector('.persona');
  const patientDom = pacienteSlot.querySelector('.persona');
  const partnerDom = partnerLeftSlot.querySelector('.persona') || partnerRightSlot.querySelector('.persona');
  
  let shiftMiddle = 0;

  // 1. Alinear Paciente bajo Padres
  if ((fatherDom || motherDom) && patientDom) {
    let parentsCenter = 0;
    if (fatherDom && motherDom) {
      parentsCenter = (getCenterX(fatherDom) + getCenterX(motherDom)) / 2;
    } else {
      parentsCenter = getCenterX(fatherDom || motherDom);
    }
    const patientNaturalCenter = getCenterX(patientDom);
    shiftMiddle = parentsCenter - patientNaturalCenter;
  }

  // 2. Alinear Hijos bajo Matrimonio
  let shiftHijos = 0;
  const hijosNodes = Array.from(hijosSlot.querySelectorAll('.persona'));

  if (patientDom && hijosNodes.length > 0) {
    const patientVisualX = getCenterX(patientDom) + shiftMiddle;
    let marriageVisualCenter = patientVisualX;

    if (partnerDom) {
      const partnerVisualX = getCenterX(partnerDom) + shiftMiddle;
      marriageVisualCenter = (patientVisualX + partnerVisualX) / 2;
    }

    const firstChildRect = hijosNodes[0].getBoundingClientRect();
    const lastChildRect = hijosNodes[hijosNodes.length - 1].getBoundingClientRect();
    const childrenGroupCenter = (firstChildRect.left + lastChildRect.right) / 2;
    shiftHijos = marriageVisualCenter - childrenGroupCenter;
  }

  // Aplicar transforms
  if (Math.abs(shiftMiddle) > 0.5) middleRow.style.transform = `translateX(${shiftMiddle}px)`;
  if (Math.abs(shiftHijos) > 0.5) hijosRow.style.transform = `translateX(${shiftHijos}px)`;
}

/* ========== Renderizar ========== */
function render() {
  padreSlot.innerHTML = ''; madreSlot.innerHTML = '';
  partnerLeftSlot.innerHTML = ''; partnerRightSlot.innerHTML = '';
  hermanosLeft.innerHTML = ''; hermanosRight.innerHTML = '';
  pacienteSlot.innerHTML = ''; hijosSlot.innerHTML = '';

  if (parents.father) padreSlot.appendChild(crearNodo(parents.father));
  if (parents.mother) madreSlot.appendChild(crearNodo(parents.mother));

  if (!patient) {
    siblings.sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0)).forEach(s => hermanosRight.appendChild(crearNodo(s)));
    requestAnimationFrame(dibujarConexiones);
    return;
  }

  const sortedSiblings = [...siblings].sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0));
  const pAge = getNum(patient.edad) || 0;
  
  let insertIndex = Math.floor(sortedSiblings.length / 2);
  const maxSibAge = sortedSiblings.length ? (getNum(sortedSiblings[0].edad)||0) : null;
  const minSibAge = sortedSiblings.length ? (getNum(sortedSiblings[sortedSiblings.length-1].edad)||0) : null;

  if (sortedSiblings.length > 0) {
      if (maxSibAge !== null && pAge > maxSibAge) insertIndex = 0;
      else if (minSibAge !== null && pAge < minSibAge) insertIndex = sortedSiblings.length;
  }

  const sequence = [...sortedSiblings];
  sequence.splice(insertIndex, 0, patient);
  
  const leftSeq = sequence.slice(0, insertIndex);
  const rightSeq = sequence.slice(insertIndex + 1);

  leftSeq.forEach(s => hermanosLeft.appendChild(crearNodo(s)));
  pacienteSlot.appendChild(crearNodo(patient));
  rightSeq.forEach(s => hermanosRight.appendChild(crearNodo(s)));

  if (partner) {
    if (partner.sexo === 'M') partnerLeftSlot.appendChild(crearNodo(partner));
    else partnerRightSlot.appendChild(crearNodo(partner));
  }

  children.sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0))
    .forEach(h => hijosSlot.appendChild(crearNodo(h)));

  // Doble frame para asegurar layout
  requestAnimationFrame(() => {
    alinearGenograma();
    requestAnimationFrame(() => {
      dibujarConexiones(); 
    });
  });
}

/* ========== Dibujar conexiones (CORREGIDO CLIPPING) ========== */
function dibujarConexiones() {
  // CORRECCI칍N: Usar scrollWidth/Height para cubrir todo el contenido desbordado
  const width = Math.max(genogramaContainer.scrollWidth, genogramaContainer.offsetWidth);
  const height = Math.max(genogramaContainer.scrollHeight, genogramaContainer.offsetHeight);
  const rect = genogramaContainer.getBoundingClientRect(); // Para coordenadas relativas
  
  if (!stage) {
    stage = new Konva.Stage({ container: 'conexiones', width, height });
    layer = new Konva.Layer();
    stage.add(layer);
  } else {
    stage.width(width); 
    stage.height(height);
    layer.destroyChildren();
  }

  // Helper de coordenadas que compensa scroll si fuera necesario
  function centerOf(el) {
    if (!el) return null;
    const r = el.getBoundingClientRect();
    return {
      x: r.left + r.width / 2 - rect.left + genogramaContainer.scrollLeft,
      y: r.top + r.height / 2 - rect.top + genogramaContainer.scrollTop,
      top: r.top - rect.top + genogramaContainer.scrollTop,
      bottom: r.bottom - rect.top + genogramaContainer.scrollTop
    };
  }

  const fatherDom = padreSlot.querySelector('.persona');
  const motherDom = madreSlot.querySelector('.persona');
  const partnerDom = partnerLeftSlot.querySelector('.persona') || partnerRightSlot.querySelector('.persona');
  const patientDom = pacienteSlot.querySelector('.persona');
  
  const leftSibs = Array.from(hermanosLeft.querySelectorAll('.persona'));
  const rightSibs = Array.from(hermanosRight.querySelectorAll('.persona'));
  const hijosDom = Array.from(hijosSlot.querySelectorAll('.persona'));

  // 1) Padres
  if (fatherDom && motherDom) {
    const cf = centerOf(fatherDom), cm = centerOf(motherDom);
    layer.add(new Konva.Line({ points: [cf.x, cf.y, cm.x, cm.y], stroke: 'black', strokeWidth: 2 }));
  }

  // 2) Padres -> Descendencia
  const allChildren = [...leftSibs, patientDom, ...rightSibs].filter(Boolean);
  if ((fatherDom || motherDom) && allChildren.length) {
    let originX, originY;
    if (fatherDom && motherDom) {
      const cf = centerOf(fatherDom), cm = centerOf(motherDom);
      originX = (cf.x + cm.x) / 2;
      originY = (cf.y + cm.y) / 2; 
    } else {
      const single = centerOf(fatherDom || motherDom);
      originX = single.x; originY = single.bottom;
    }

    const minTop = Math.min(...allChildren.map(s => centerOf(s).top));
    const yBar = (originY + minTop) / 2 + 10;

    layer.add(new Konva.Line({ points: [originX, originY, originX, yBar], stroke: 'black', strokeWidth: 2 }));

    allChildren.forEach(s => {
      const c = centerOf(s);
      layer.add(new Konva.Line({ points: [c.x, c.top, c.x, yBar], stroke: 'black', strokeWidth: 2 }));
      layer.add(new Konva.Line({ points: [originX, yBar, c.x, yBar], stroke: 'black', strokeWidth: 2 }));
    });
  }

  // 3) Matrimonio (Paciente <-> Pareja)
  if (partnerDom && patientDom) {
    const cp = centerOf(partnerDom);
    const cpa = centerOf(patientDom);
    layer.add(new Konva.Line({ points: [cp.x, cp.y, cpa.x, cpa.y], stroke: 'black', strokeWidth: 2 }));
  }

  // 4) Hijos
  if (patientDom && hijosDom.length) {
    const cPatient = centerOf(patientDom);
    let startX, startY;

    if (partnerDom) {
      const cPartner = centerOf(partnerDom);
      startX = (cPatient.x + cPartner.x) / 2;
      startY = (cPatient.y + cPartner.y) / 2;
    } else {
      startX = cPatient.x;
      startY = cPatient.bottom;
    }

    const minChildTop = Math.min(...hijosDom.map(h => centerOf(h).top));
    const yEnd = (startY + minChildTop) / 2 + 15;
    
    layer.add(new Konva.Line({ points: [startX, startY, startX, yEnd], stroke: 'black', strokeWidth: 2 }));

    hijosDom.forEach(h => {
      const ch = centerOf(h);
      layer.add(new Konva.Line({ points: [startX, yEnd, ch.x, yEnd], stroke: 'black', strokeWidth: 2 }));
      layer.add(new Konva.Line({ points: [ch.x, yEnd, ch.x, ch.top], stroke: 'black', strokeWidth: 2 }));
    });
  }

  layer.draw();
}

/* ========== Eventos ========== */
agregarPacienteBtn.onclick = () => {
  const nombre = document.getElementById('nombre').value.trim();
  if (!nombre) return alert('Ingresa nombre');
  patient = { id:uid(), nombre, apellido:document.getElementById('apellido').value, edad:document.getElementById('edad').value, sexo:document.getElementById('sexo').value, esPaciente:true };
  formPaciente.style.display='none'; render();
};

function abrirMenu(x,y){ menu.style.left=x+'px'; menu.style.top=y+'px'; menu.classList.remove('oculto'); }
function cerrarMenu(){ menu.classList.add('oculto'); seleccionado=null; }
menuAgregarBtn.onclick = ()=>{ cerrarMenu(); abrirFormFamiliar(); };
menuEliminarBtn.onclick = ()=>{ if(seleccionado) eliminarSeleccionado(); cerrarMenu(); };
function abrirFormFamiliar(){ formFamiliar.classList.remove('oculto'); }
function cerrarFormFamiliar(){ formFamiliar.classList.add('oculto'); }

guardarFamiliarBtn.onclick = ()=>{
  const nom = document.getElementById('famNombre').value.trim();
  if(!nom) return;
  const p = { id:uid(), nombre:nom, apellido:document.getElementById('famApellido').value, edad:document.getElementById('famEdad').value, sexo:document.getElementById('famSexo').value };
  const rol = document.getElementById('famRol').value;
  if(rol==='padre') { if(p.sexo==='M') parents.father=p; else parents.mother=p; }
  else if(rol==='pareja') partner=p;
  else if(rol==='hermano') siblings.push(p);
  else if(rol==='hijo') children.push(p);
  cerrarFormFamiliar(); render();
};

function eliminarSeleccionado(){
  const id = seleccionado.id;
  if(patient && patient.id===id) { patient=null; formPaciente.style.display='block'; }
  if(parents.father && parents.father.id===id) parents.father=null;
  if(parents.mother && parents.mother.id===id) parents.mother=null;
  if(partner && partner.id===id) partner=null;
  siblings = siblings.filter(s=>s.id!==id);
  children = children.filter(c=>c.id!==id);
  render();
}

window.addEventListener('resize', () => {
  if (stage) { stage.destroy(); stage=null; layer=null; }
  alinearGenograma();
  requestAnimationFrame(() => dibujarConexiones());
});

const params = new URLSearchParams(window.location.search);
if(params.has('nombre')){
   patient = { id:uid(), nombre:params.get('nombre'), apellido:params.get('apellido')||'', edad:params.get('edad')||0, sexo:params.get('sexo')||'M', esPaciente:true };
   formPaciente.style.display='none';
}

render();
</script>
</body>
</html>