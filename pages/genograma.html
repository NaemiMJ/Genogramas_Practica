<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Genograma</title>
  <link rel="stylesheet" href="../style/style_geno.css">
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    /* Estilos base */
    .middle-row { display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 40px; /* Espacio extra para la l칤nea U */ }
    .pareja-slot { width: 140px; display:flex; justify-content:center; }
    .center-block { display:flex; align-items:center; justify-content:center; gap:12px; }
    .hermanos { display:flex; gap:12px; align-items:center; }
    .paciente-slot { min-width:120px; display:flex; justify-content:center; }
    #conexiones { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
    .genograma-container { position:relative; padding-bottom: 50px; }
  </style>
</head>
<body>
  <h1>Genograma</h1>
  <button id="btnGuardarDB" class="btn-save">游 Guardar Cambios</button>

  <div class="form-wrapper" id="formPaciente">
    <h3>Agregar paciente</h3>
    <label>Nombre: <input type="text" id="nombre" /></label>
    <label>Apellido: <input type="text" id="apellido" /></label>
    <label>Edad: <input type="number" id="edad" min="0" /></label>
    <label>Sexo:
      <select id="sexo">
        <option value="M">Masculino</option>
        <option value="F">Femenino</option>
      </select>
    </label>
    <div style="margin-top:8px">
      <button id="agregarPaciente">Agregar paciente</button>
    </div>
  </div>

  <div class="genograma-container">
    <div id="conexiones"></div>

    <div class="genograma">
      <div class="fila padres" id="padres">
        <div class="parent-slot" id="padre-slot"></div>
        <div class="parent-slot" id="madre-slot"></div>
      </div>

      <div class="fila middle-row" id="middle">
        <div class="pareja-slot" id="partner-left-slot"></div>

        <div class="center-block" id="center-block">
          <div class="hermanos left" id="hermanos-left"></div>
          <div class="paciente-slot" id="paciente-slot"></div>
          <div class="hermanos right" id="hermanos-right"></div>
        </div>

        <div class="pareja-slot" id="partner-right-slot"></div>
      </div>

      <div class="fila hijos" id="hijos"></div>
    </div>
  </div>

  <div id="formFamiliar" class="modal oculto" role="dialog" aria-hidden="true">
    <div class="modal-inner">
      <h4>Agregar familiar</h4>
      <label>Nombre: <input type="text" id="famNombre" /></label>
      <label>Apellido: <input type="text" id="famApellido" /></label>
      <label>Edad: <input type="number" id="famEdad" min="0" /></label>
      <label>Sexo:
        <select id="famSexo">
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </label>
      <label>Rol:
        <select id="famRol">
          <option value="padre">Padre/Madre</option>
          <option value="pareja">Pareja</option>
          <option value="hermano">Hermano/a</option>
          <option value="hijo">Hijo/a</option>
        </select>
      </label>
      <label>Salud / Problemas:
        <select id="famSalud" style="width:100%">
          <option value="ninguno">Ninguno</option>
          <option value="abuso">Abuso Alcohol/Drogas</option>
          <option value="ingreso">Ingreso / Recuperaci칩n</option> <option value="sospecha">Sospecha de Abuso</option>
          <option value="mental">Prob. Mentales / Psicol칩gicos</option>
          <option value="ambos">Comorbilidad (Abuso + Mental)</option>
        </select>
      </label>
      <label>Estado Vital:
        <select id="famEstado" style="width:100%">
          <option value="vivo">Vivo (Normal)</option>
          <option value="fallecido">Fallecido (X Grande)</option>
          <option value="embarazo">Embarazo (Tri치ngulo)</option>
          <option value="neonato_x">Muerte al nacer (Peque침o con X)</option>
          <option value="aborto_esp">Aborto Espont치neo (Punto Negro)</option>
          <option value="aborto_prov">Aborto Provocado (x peque침a)</option>
        </select>
      </label>
      <label style="display:inline-flex; align-items:center; gap:5px; margin-top:5px;">
        <input type="checkbox" id="famLgtb" /> 
        LGTBIQ+
      </label>
      <label id="lblDivorcio" style="display:inline-flex; align-items:center; gap:5px; margin-top:5px;">
        <input type="checkbox" id="famDivorcio" /> Divorcio / Ex-Pareja
      </label>

      <div class="modal-actions" style="margin-top:8px;">
        <button id="guardarFamiliarBtn">Agregar</button>
        <button type="button" onclick="cerrarFormFamiliar()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="menuAcciones" class="menu-acciones oculto">
    <button id="menuAgregar">Agregar familiar</button>
    <button id="menuEliminar">Eliminar</button>
    <button onclick="cerrarMenu()">Cerrar</button>
  </div>

<script>
/* ========== Modelo de datos ========== */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

let patient = null;
let parents = { father: null, mother: null };
let partner = null;
let siblings = [];
let children = [];
let seleccionado = null;

/* ========== Selectores DOM ========== */
const padreSlot = document.getElementById('padre-slot');
const madreSlot = document.getElementById('madre-slot');
const partnerLeftSlot = document.getElementById('partner-left-slot');
const partnerRightSlot = document.getElementById('partner-right-slot');
const hermanosLeft = document.getElementById('hermanos-left');
const hermanosRight = document.getElementById('hermanos-right');
const pacienteSlot = document.getElementById('paciente-slot');
const hijosSlot = document.getElementById('hijos');
const genogramaContainer = document.querySelector('.genograma-container');
const middleRow = document.getElementById('middle'); 
const hijosRow = document.getElementById('hijos'); 

const formPaciente = document.getElementById('formPaciente');
const agregarPacienteBtn = document.getElementById('agregarPaciente');
const menu = document.getElementById('menuAcciones');
const menuAgregarBtn = document.getElementById('menuAgregar');
const menuEliminarBtn = document.getElementById('menuEliminar');
const formFamiliar = document.getElementById('formFamiliar');
const guardarFamiliarBtn = document.getElementById('guardarFamiliarBtn');

const famRolSelect = document.getElementById('famRol');
const lblDivorcio = document.getElementById('lblDivorcio');
const chkDivorcio = document.getElementById('famDivorcio');

function toggleDivorcioOption() {
  // Si el valor seleccionado es 'pareja', mostramos el label (usamos 'inline-flex' porque as칤 estaba en tu estilo original)
  if (famRolSelect.value === 'pareja') {
    lblDivorcio.style.display = 'inline-flex';
  } else {
    // Si no es pareja, ocultamos y desmarcamos la casilla por seguridad
    lblDivorcio.style.display = 'none';
    chkDivorcio.checked = false;
  }
}

// Ejecutar la funci칩n cada vez que cambie el select
famRolSelect.addEventListener('change', toggleDivorcioOption);

/* --- L칍GICA: FILTRAR ESTADOS SEG칔N ROL --- */
const famEstadoSelect = document.getElementById('famEstado');

function filtrarOpcionesEstado() {
  const rol = famRolSelect.value;
  
  // Lista de estados que SOLO tienen sentido para descendencia (Hijos) o colaterales (Hermanos)
  // 'embarazo', 'neonato_x', 'aborto_esp', 'aborto_prov'
  const estadosProhibidosParaAdultos = ['embarazo', 'neonato_x', 'aborto_esp', 'aborto_prov'];
  
  // Recorremos todas las opciones del selector de Estado
  for (let i = 0; i < famEstadoSelect.options.length; i++) {
    const opt = famEstadoSelect.options[i];
    
    // Si la opci칩n actual es una de las "infantiles/gestacionales"
    if (estadosProhibidosParaAdultos.includes(opt.value)) {
      
      // Si el rol es PADRE o PAREJA -> Ocultamos
      if (rol === 'padre' || rol === 'pareja') {
        opt.hidden = true;      // Lo esconde visualmente
        opt.disabled = true;    // Lo deshabilita por seguridad
        opt.style.display = 'none'; // Refuerzo para algunos navegadores
      } 
      // Si el rol es HIJO o HERMANO -> Mostramos
      else {
        opt.hidden = false;
        opt.disabled = false;
        opt.style.display = 'block';
      }
    }
  }

  // REVISI칍N DE SEGURIDAD:
  // Si el usuario ten칤a seleccionado "Embarazo" y cambia el rol a "Padre",
  // el select se quedar칤a con un valor inv치lido. Lo reseteamos a "vivo".
  const valorActual = famEstadoSelect.value;
  if (estadosProhibidosParaAdultos.includes(valorActual) && (rol === 'padre' || rol === 'pareja')) {
    famEstadoSelect.value = 'vivo';
  }
}

/* --- A. L칍GICA DE BLOQUEO (Sin drogas/LGTB para fetos) --- */
function actualizarCamposPorEstado() {
  const estado = famEstadoSelect.value;
  const saludSelect = document.getElementById('famSalud');
  const lgtbCheck = document.getElementById('famLgtb');
  
  // Si es embarazo, neonato o aborto -> No aplica salud ni lgtb
  const estadosInfantiles = ['embarazo', 'neonato_x', 'aborto_esp', 'aborto_prov'];
  
  if (estadosInfantiles.includes(estado)) {
    // 1. Reseteamos valores
    saludSelect.value = 'ninguno';
    lgtbCheck.checked = false;
    
    // 2. Deshabilitamos y bajamos opacidad visual
    saludSelect.disabled = true;
    lgtbCheck.disabled = true;
    saludSelect.parentElement.style.opacity = '0.5';
    lgtbCheck.parentElement.style.opacity = '0.5';
  } else {
    // Reactivamos para vivos o fallecidos adultos
    saludSelect.disabled = false;
    lgtbCheck.disabled = false;
    saludSelect.parentElement.style.opacity = '1';
    lgtbCheck.parentElement.style.opacity = '1';
  }
}
// Activar el bloqueo al cambiar estado
famEstadoSelect.addEventListener('change', actualizarCamposPorEstado);

// Ejecutar el filtro cada vez que cambiamos el ROL
famRolSelect.addEventListener('change', filtrarOpcionesEstado);

/* ========== Utilidades ========== */
const getNum = v => { const n = parseInt(v); return Number.isFinite(n) ? n : null; };
function getCenterX(el) { const r = el.getBoundingClientRect(); return r.left + r.width / 2; }

/* ========== Crear nodo persona (CORREGIDO) ========== */
function crearNodo(persona) {
  const div = document.createElement('div');
  
  // 1. Asignaci칩n de Clases
  let clases = 'persona ' + (persona.sexo === 'M' ? 'hombre' : 'mujer');
  
  if (persona.esPaciente) clases += ' paciente';
  
  // Estados Vitales
  if (persona.estado === 'fallecido') clases += ' fallecido';
  else if (persona.estado === 'embarazo') clases += ' embarazo';
  else if (persona.estado === 'neonato_x') clases += ' neonato-x';
  else if (persona.estado === 'aborto_esp') clases += ' aborto-esp';
  else if (persona.estado === 'aborto_prov') clases += ' aborto-prov';

  // Salud
  if (persona.salud && persona.salud !== 'ninguno') {
    clases += ' patron-' + persona.salud; 
  }

  // LGTB
  if (persona.lgtb) clases += ' lgtb'; 
  
  div.className = clases;
  div.dataset.id = persona.id;

  // 2. Elemento Tri치ngulo LGTB (Si corresponde)
  if (persona.lgtb) {
    const tri = document.createElement('div');
    tri.className = 'simbolo-lgtb';
    div.appendChild(tri);
  }

  // 3. Texto: Nombre y Edad
  // Aqu칤 est치 el filtro: SOLO ocultamos en abortos.
  const sinTexto = ['aborto_esp', 'aborto_prov']; 
  
  if (!sinTexto.includes(persona.estado)) {
    const nombre = document.createElement('div');
    nombre.className = 'nombre';
    nombre.textContent = persona.nombre + (persona.apellido ? (' ' + persona.apellido) : '');

    const edad = document.createElement('div');
    edad.className = 'edad';
    edad.textContent = persona.edad ? (persona.edad + ' a침os') : '';

    div.appendChild(nombre);
    div.appendChild(edad);
  }
  
  // --- AQU칈 ESTABA EL ERROR: HAB칈A OTRO BLOQUE IGUAL QUE A칌AD칈A EL NOMBRE OTRA VEZ ---
  // (Ya lo he borrado en esta versi칩n)

  div.addEventListener('click', (e) => {
    e.stopPropagation();
    seleccionado = persona;
    abrirMenu(e.pageX, e.pageY);
  });
  
  return div;
}

/* ========== Konva Config ========== */
let stage = null;
let layer = null;

/* ========== L칩gica de Alineaci칩n (CORREGIDA) ========== */
function alinearGenograma() {
  middleRow.style.transform = '';
  hijosRow.style.transform = '';

  const fatherDom = padreSlot.querySelector('.persona');
  const motherDom = madreSlot.querySelector('.persona');
  const patientDom = pacienteSlot.querySelector('.persona');
  const partnerDom = partnerLeftSlot.querySelector('.persona') || partnerRightSlot.querySelector('.persona');
  
  // Recopilar todos los nodos de la generaci칩n del paciente (Hermanos izq + Paciente + Hermanos der)
  const leftSibs = Array.from(hermanosLeft.querySelectorAll('.persona'));
  const rightSibs = Array.from(hermanosRight.querySelectorAll('.persona'));
  // Es vital mantener el orden visual: [Hermanos Izq] -> [Paciente] -> [Hermanos Der]
  const allSiblingsNodes = [...leftSibs, patientDom, ...rightSibs].filter(Boolean);

  let shiftMiddle = 0;

  // Si hay padres y hay hijos (paciente o hermanos)
  if ((fatherDom || motherDom) && allSiblingsNodes.length > 0) {
    let parentsCenter = 0;
    
    // 1. Calcular centro de los padres
    if (fatherDom && motherDom) {
      parentsCenter = (getCenterX(fatherDom) + getCenterX(motherDom)) / 2;
    } else {
      parentsCenter = getCenterX(fatherDom || motherDom);
    }

    // 2. Calcular centro del GRUPO de hijos (no solo del paciente)
    const firstRect = allSiblingsNodes[0].getBoundingClientRect();
    const lastRect = allSiblingsNodes[allSiblingsNodes.length - 1].getBoundingClientRect();
    
    // El centro es el promedio entre el borde izquierdo del primer hijo y el borde derecho del 칰ltimo
    const childrenGroupCenter = (firstRect.left + lastRect.right) / 2;

    // 3. El desplazamiento es la diferencia entre el centro de los padres y el centro del grupo de hijos
    shiftMiddle = parentsCenter - childrenGroupCenter;
  }

  // --- L칩gica para los hijos del paciente (se mantiene igual, pero usa el nuevo shiftMiddle) ---
  let shiftHijos = 0;
  const hijosNodes = Array.from(hijosSlot.querySelectorAll('.persona'));

  if (patientDom && hijosNodes.length > 0) {
    // Es importante sumar el shiftMiddle actual para saber d칩nde quedar치 visualmente el paciente
    const patientVisualX = getCenterX(patientDom) + shiftMiddle;
    let marriageVisualCenter = patientVisualX;

    if (partnerDom) {
      const partnerVisualX = getCenterX(partnerDom) + shiftMiddle;
      marriageVisualCenter = (patientVisualX + partnerVisualX) / 2;
    }

    const firstChildRect = hijosNodes[0].getBoundingClientRect();
    const lastChildRect = hijosNodes[hijosNodes.length - 1].getBoundingClientRect();
    const childrenGroupCenter = (firstChildRect.left + lastChildRect.right) / 2;
    
    shiftHijos = marriageVisualCenter - childrenGroupCenter;
  }

  // Aplicar transformaciones
  if (Math.abs(shiftMiddle) > 0.5) middleRow.style.transform = `translateX(${shiftMiddle}px)`;
  if (Math.abs(shiftHijos) > 0.5) hijosRow.style.transform = `translateX(${shiftHijos}px)`;
}

/* ========== Renderizar ========== */
function render() {
  padreSlot.innerHTML = ''; madreSlot.innerHTML = '';
  partnerLeftSlot.innerHTML = ''; partnerRightSlot.innerHTML = '';
  hermanosLeft.innerHTML = ''; hermanosRight.innerHTML = '';
  pacienteSlot.innerHTML = ''; hijosSlot.innerHTML = '';

  if (parents.father) padreSlot.appendChild(crearNodo(parents.father));
  if (parents.mother) madreSlot.appendChild(crearNodo(parents.mother));

  if (!patient) {
    siblings.sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0)).forEach(s => hermanosRight.appendChild(crearNodo(s)));
    requestAnimationFrame(dibujarConexiones);
    return;
  }

  const sortedSiblings = [...siblings].sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0));
  const pAge = getNum(patient.edad) || 0;
  let insertIndex = Math.floor(sortedSiblings.length / 2);
  const maxSibAge = sortedSiblings.length ? (getNum(sortedSiblings[0].edad)||0) : null;
  const minSibAge = sortedSiblings.length ? (getNum(sortedSiblings[sortedSiblings.length-1].edad)||0) : null;

  if (sortedSiblings.length > 0) {
      if (maxSibAge !== null && pAge > maxSibAge) insertIndex = 0;
      else if (minSibAge !== null && pAge < minSibAge) insertIndex = sortedSiblings.length;
  }

  const sequence = [...sortedSiblings];
  sequence.splice(insertIndex, 0, patient);
  const leftSeq = sequence.slice(0, insertIndex);
  const rightSeq = sequence.slice(insertIndex + 1);

  leftSeq.forEach(s => hermanosLeft.appendChild(crearNodo(s)));
  pacienteSlot.appendChild(crearNodo(patient));
  rightSeq.forEach(s => hermanosRight.appendChild(crearNodo(s)));

  if (partner) {
    if (partner.sexo === 'M') partnerLeftSlot.appendChild(crearNodo(partner));
    else partnerRightSlot.appendChild(crearNodo(partner));
  }

  children.sort((a,b) => (getNum(b.edad)||0) - (getNum(a.edad)||0))
    .forEach(h => hijosSlot.appendChild(crearNodo(h)));

  requestAnimationFrame(() => {
    alinearGenograma();
    requestAnimationFrame(() => {
      dibujarConexiones(); 
    });
  });
}

/* ========== DIBUJO DE CONEXIONES (FORMA DE U) ========== */
function dibujarConexiones() {
  const width = Math.max(genogramaContainer.scrollWidth, genogramaContainer.offsetWidth);
  const height = Math.max(genogramaContainer.scrollHeight, genogramaContainer.offsetHeight);
  const rect = genogramaContainer.getBoundingClientRect(); 
  
  if (!stage) {
    stage = new Konva.Stage({ container: 'conexiones', width, height });
    layer = new Konva.Layer();
    stage.add(layer);
  } else {
    stage.width(width); 
    stage.height(height);
    layer.destroyChildren();
  }

  function centerOf(el) {
    if (!el) return null;
    const r = el.getBoundingClientRect();
    return {
      x: r.left + r.width / 2 - rect.left + genogramaContainer.scrollLeft,
      y: r.top + r.height / 2 - rect.top + genogramaContainer.scrollTop,
      top: r.top - rect.top + genogramaContainer.scrollTop,
      bottom: r.bottom - rect.top + genogramaContainer.scrollTop
    };
  }

  const fatherDom = padreSlot.querySelector('.persona');
  const motherDom = madreSlot.querySelector('.persona');
  const partnerDom = partnerLeftSlot.querySelector('.persona') || partnerRightSlot.querySelector('.persona');
  const patientDom = pacienteSlot.querySelector('.persona');
  
  const leftSibs = Array.from(hermanosLeft.querySelectorAll('.persona'));
  const rightSibs = Array.from(hermanosRight.querySelectorAll('.persona'));
  const hijosDom = Array.from(hijosSlot.querySelectorAll('.persona'));

  // 1) Padres
  if (fatherDom && motherDom) {
    const cf = centerOf(fatherDom), cm = centerOf(motherDom);
    layer.add(new Konva.Line({ points: [cf.x, cf.y, cm.x, cm.y], stroke: 'black', strokeWidth: 2 }));
  }

  // 2) Padres -> Descendencia
  const allChildren = [...leftSibs, patientDom, ...rightSibs].filter(Boolean);
  if ((fatherDom || motherDom) && allChildren.length) {
    let originX, originY;
    if (fatherDom && motherDom) {
      const cf = centerOf(fatherDom), cm = centerOf(motherDom);
      originX = (cf.x + cm.x) / 2;
      originY = (cf.y + cm.y) / 2; 
    } else {
      const single = centerOf(fatherDom || motherDom);
      originX = single.x; originY = single.bottom;
    }

    const minTop = Math.min(...allChildren.map(s => centerOf(s).top));
    const yBar = (originY + minTop) / 2 + 10;

    layer.add(new Konva.Line({ points: [originX, originY, originX, yBar], stroke: 'black', strokeWidth: 2 }));

    allChildren.forEach(s => {
      const c = centerOf(s);
      layer.add(new Konva.Line({ points: [c.x, c.top, c.x, yBar], stroke: 'black', strokeWidth: 2 }));
      layer.add(new Konva.Line({ points: [originX, yBar, c.x, yBar], stroke: 'black', strokeWidth: 2 }));
    });
  }

  // ===============================================
  // 3) MATRIMONIO CON FORMA DE "U" (Bracket)
  // ===============================================
  let marriageY = 0; // Guardamos la altura de la uni칩n para usarla con los hijos

  if (partnerDom && patientDom) {
    const cp = centerOf(partnerDom);
    const cpa = centerOf(patientDom);
    
    // Calculamos una altura "segura" debajo de ambos nodos
    // Bajamos 25px respecto al nodo m치s bajo para asegurar que pasamos "por debajo" de los hermanos
    marriageY = Math.max(cp.bottom, cpa.bottom) + 25;

    // Dibujamos la U: [Pareja Centro] -> [Pareja Abajo] -> [Paciente Abajo] -> [Paciente Centro]
    layer.add(new Konva.Line({ 
        points: [cp.x, cp.y, cp.x, marriageY, cpa.x, marriageY, cpa.x, cpa.y], 
        stroke: 'black', 
        strokeWidth: 2 
    }));

    // --- DIVORCIO ---
    if (partner && partner.divorciado) {
      const midX = (cp.x + cpa.x) / 2;
      const midY = marriageY; // La marca va en la barra horizontal inferior
      const h = 8; 

      layer.add(new Konva.Line({ 
        points: [midX - 6, midY + h, midX - 2, midY - h], 
        stroke: 'black', strokeWidth: 2 
      }));
      layer.add(new Konva.Line({ 
        points: [midX + 2, midY + h, midX + 6, midY - h], 
        stroke: 'black', strokeWidth: 2 
      }));
    }
  }

  // ===============================================
  // 4) HIJOS (Colgando de la barra U)
  // ===============================================
  if (patientDom && hijosDom.length) {
    const cPatient = centerOf(patientDom);
    let startX, startY;

    if (partnerDom) {
      const cPartner = centerOf(partnerDom);
      // El origen de los hijos es el centro de la barra horizontal inferior (la U)
      startX = (cPatient.x + cPartner.x) / 2;
      startY = marriageY; 
    } else {
      // Madre/Padre soltero
      startX = cPatient.x;
      startY = cPatient.bottom;
    }

    const minChildTop = Math.min(...hijosDom.map(h => centerOf(h).top));
    const yEnd = (startY + minChildTop) / 2 + 15;
    
    // Tallo vertical desde el matrimonio hacia abajo
    layer.add(new Konva.Line({ points: [startX, startY, startX, yEnd], stroke: 'black', strokeWidth: 2 }));

    // Barra horizontal sobre los hijos y bajadas individuales
    hijosDom.forEach(h => {
      const ch = centerOf(h);
      layer.add(new Konva.Line({ points: [startX, yEnd, ch.x, yEnd], stroke: 'black', strokeWidth: 2 }));
      layer.add(new Konva.Line({ points: [ch.x, yEnd, ch.x, ch.top], stroke: 'black', strokeWidth: 2 }));
    });
  }

  layer.draw();
}

/* ========== Eventos ========== */
agregarPacienteBtn.onclick = () => {
  const nombre = document.getElementById('nombre').value.trim();
  if (!nombre) return alert('Ingresa nombre');
  patient = { id:uid(), nombre, apellido:document.getElementById('apellido').value, edad:document.getElementById('edad').value, sexo:document.getElementById('sexo').value, esPaciente:true };
  formPaciente.style.display='none'; render();
};

function abrirMenu(x,y){ menu.style.left=x+'px'; menu.style.top=y+'px'; menu.classList.remove('oculto'); }
function cerrarMenu(){ menu.classList.add('oculto'); seleccionado=null; }
menuAgregarBtn.onclick = ()=>{ cerrarMenu(); abrirFormFamiliar(); };
menuEliminarBtn.onclick = ()=>{ if(seleccionado) eliminarSeleccionado(); cerrarMenu(); };
/* --- B. INICIALIZACI칍N --- */
function abrirFormFamiliar(){ 
  formFamiliar.classList.remove('oculto'); 
  toggleDivorcioOption(); 
  filtrarOpcionesEstado();   // Ocultar embarazo si es "Padre"
  actualizarCamposPorEstado(); // Bloquear salud/lgtb si ya estaba marcado un aborto
}
function cerrarFormFamiliar(){ formFamiliar.classList.add('oculto'); }

/* --- C. BOT칍N GUARDAR (Validaci칩n de Nombre relajada) --- */
guardarFamiliarBtn.onclick = ()=>{
  const nomInput = document.getElementById('famNombre');
  const apeInput = document.getElementById('famApellido');
  const edadInput = document.getElementById('famEdad');
  const sexoInput = document.getElementById('famSexo');
  const rolInput = document.getElementById('famRol');
  const estadoInput = document.getElementById('famEstado');
  const saludInput = document.getElementById('famSalud');
  const lgtbInput = document.getElementById('famLgtb');
  const divorcioInput = document.getElementById('famDivorcio'); 
  const estado = estadoInput.value;
  const nom = nomInput.value.trim();

  // --- CAMBIO AQU칈: Permitir sin nombre si es p칠rdida o embarazo ---
  const permiteSinNombre = ['embarazo', 'aborto_esp', 'aborto_prov'].includes(estado);
  
  if(!nom && !permiteSinNombre) {
    return alert("Por favor ingresa un nombre");
  }

  const p = { 
    id: uid(), 
    // Si no pone nombre, guardamos cadena vac칤a para que no salga "undefined"
    nombre: nom || '', 
    apellido: apeInput.value, 
    edad: edadInput.value, 
    sexo: sexoInput.value,
    estado: estado, 
    salud: saludInput.value,
    lgtb: lgtbInput.checked,
    divorciado: divorcioInput.checked 
  };

  const rol = rolInput.value;
  if(rol==='padre') { if(p.sexo==='M') parents.father=p; else parents.mother=p; }
  else if(rol==='pareja') partner=p;
  else if(rol==='hermano') siblings.push(p);
  else if(rol==='hijo') children.push(p);
  
  // RESET
  nomInput.value = ''; apeInput.value = ''; edadInput.value = '';
  estadoInput.value = 'vivo'; saludInput.value = 'ninguno';
  lgtbInput.checked = false; divorcioInput.checked = false;
  sexoInput.value = 'M'; rolInput.value = 'hijo';

  cerrarFormFamiliar(); 
  render();
};

function eliminarSeleccionado(){
  const id = seleccionado.id;
  if(patient && patient.id===id) { patient=null; formPaciente.style.display='block'; }
  if(parents.father && parents.father.id===id) parents.father=null;
  if(parents.mother && parents.mother.id===id) parents.mother=null;
  if(partner && partner.id===id) partner=null;
  siblings = siblings.filter(s=>s.id!==id);
  children = children.filter(c=>c.id!==id);
  render();
}

window.addEventListener('resize', () => {
  if (stage) { stage.destroy(); stage=null; layer=null; }
  alinearGenograma();
  requestAnimationFrame(() => dibujarConexiones());
});

const params = new URLSearchParams(window.location.search);
if(params.has('nombre')){
   patient = { id:uid(), nombre:params.get('nombre'), apellido:params.get('apellido')||'', edad:params.get('edad')||0, sexo:params.get('sexo')||'M', esPaciente:true };
   formPaciente.style.display='none';
}

render();
</script>
</body>
</html>